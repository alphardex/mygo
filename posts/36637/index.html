<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="将TUIKit从uni-app迁移到taro"><meta name="keywords" content=""><meta name="author" content="alphardex"><meta name="copyright" content="alphardex"><title>将TUIKit从uni-app迁移到taro | 名無声</title><link rel="shortcut icon" href="/mygo/img/favicon.ico"><link rel="stylesheet" href="/mygo/css/index.css?version=1.9.1"><link rel="stylesheet" href="/mygo/css/mygo.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/mygo/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '7.2.0'
} </script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/mygo/atom.xml" title="名無声" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%BA%93%E6%9C%AC%E8%BA%AB"><span class="toc-number">2.</span> <span class="toc-text">修改库本身</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Taro"><span class="toc-number">2.1.</span> <span class="toc-text">Taro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.2.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-number">2.3.</span> <span class="toc-text">事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%8F"><span class="toc-number">2.4.</span> <span class="toc-text">编译宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E9%99%A4-ts-%E9%87%8C%E5%AF%B9-vue-%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-number">2.5.</span> <span class="toc-text">去除 ts 里对 vue 的引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%91%BD%E5%90%8D%E9%87%8D%E5%90%8D%E7%BB%84%E4%BB%B6"><span class="toc-number">2.6.</span> <span class="toc-text">重命名重名组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%A0%B7%E5%BC%8F"><span class="toc-number">2.7.</span> <span class="toc-text">调整样式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%A0%B7%E5%BC%8F%E8%A6%86%E7%9B%96%E5%86%B2%E7%AA%81"><span class="toc-number">2.8.</span> <span class="toc-text">解决样式覆盖冲突</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E5%AF%BC%E8%88%AA%E8%B7%AF%E5%BE%84"><span class="toc-number">2.9.</span> <span class="toc-text">替换导航路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E5%8F%98%E9%87%8F"><span class="toc-number">2.10.</span> <span class="toc-text">替换变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%BB%9A%E5%8A%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="toc-number">2.11.</span> <span class="toc-text">解决滚动失效问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%99%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90%E5%BA%93"><span class="toc-number">3.</span> <span class="toc-text">给项目集成库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E4%B8%BB%E5%8C%85%E4%BD%93%E7%A7%AF%E8%BF%87%E5%A4%A7%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">优化主包体积过大问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text">其他优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">6.</span> <span class="toc-text">最后</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2024/05/21/NhyV4THWaAgOwED.jpg"></div><div class="author-info__name text-center">alphardex</div><div class="author-info__description text-center">&quot;普通&quot;とか&quot;あたりまえ&quot;ってなんだろう</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/mygo/archives"><span class="pull-left">Articles</span><span class="pull-right">45</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.loli.net/2024/05/21/HtNjkzv1FEdAVby.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/mygo/">名無声</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/mygo/">Home</a><a class="site-page" href="/mygo/archives">Archives</a><a class="site-page" href="/mygo/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">将TUIKit从uni-app迁移到taro</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2024-06-18</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/269/64506">TUIKit</a>是腾讯的一个基于 Chat SDK 的 UI 组件库，目前支持 H5、小程序、uni-app，但并没有对 Taro 的支持。</p>
<p>由于我的项目是基于 Taro 的，因此我先要把它 uni-app 的版本迁移到 Taro 上去。</p>
<span id="more"></span>

<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>将<a target="_blank" rel="noopener" href="https://github.com/TencentCloud/chat-uikit-uniapp">chat-uikit-uniapp</a>克隆到本地，把里面原有的 .git 和 sample 删掉，自己初始化一个 git。</p>
<p>当然，在初始化 git 之前，可以把项目名先改成<code>chat-uikit-taro</code>，毕竟 Taro 才是主体目标嘛。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/TencentCloud/chat-uikit-uniapp.git</span><br><span class="line"><span class="built_in">cd</span> chat-uikit-uniapp</span><br><span class="line">rimraf .git</span><br><span class="line">rimraf sample</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;init&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="修改库本身"><a href="#修改库本身" class="headerlink" title="修改库本身"></a>修改库本身</h2><h3 id="Taro"><a href="#Taro" class="headerlink" title="Taro"></a>Taro</h3><p>把所有<code>uni.</code>替换成<code>Taro.</code>，注意有些带有<code>-uni.png</code>的要手动排除掉。</p>
<p>由于 Taro 需要手动<code>import</code>，在所有<code>vue</code>文件的<code>script</code>部分统一补上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Taro from &quot;@tarojs/taro&quot;;</span><br><span class="line">...</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>以及</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang=&quot;ts&quot; setup&gt;</span><br><span class="line">import Taro from &quot;@tarojs/taro&quot;;</span><br><span class="line">...</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>Taro 的生命周期钩子和 uni-app 也不一样，需要找到并替换掉，搜索<code>@dcloudio/uni-app</code>，便可找到所有钩子的引入位置，所有钩子替换完后再把<code>@dcloudio/uni-app</code>替换成<code>@tarojs/taro</code>。注意要把不相关的选项手动排除掉（如<code>emit</code>）。</p>
<ul>
<li><code>onLoad</code> —— <code>useLoad</code></li>
<li><code>onUnload</code> —— <code>useUnload</code></li>
<li><code>onReady</code> —— <code>useReady</code></li>
<li><code>onHide</code> —— <code>useDidHide</code></li>
</ul>
<h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>Taro 的事件处理和 uni-app 也不一样，做以下的替换：</p>
<ul>
<li><code>$on</code> —— <code>eventCenter.on</code></li>
<li><code>$off</code> —— <code>eventCenter.off</code></li>
<li><code>$emit</code> —— <code>eventCenter.trigger</code></li>
</ul>
<h3 id="编译宏"><a href="#编译宏" class="headerlink" title="编译宏"></a>编译宏</h3><p>Taro 的编译宏和 uni-app 并不相同。</p>
<p>先搜索<code>#ifdef</code>。</p>
<p><code>adapter-vue.ts</code>中，直接把<code>vue</code>指定为<code>vue3</code>版本。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vueVersion = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">let</span> framework = <span class="string">&quot;vue3&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[adapter-vue]: vue version is <span class="subst">$&#123;vueVersion&#125;</span>`</span>);</span><br><span class="line"><span class="keyword">export</span> &#123; vueVersion, framework &#125;;</span><br></pre></td></tr></table></figure>

<p><code>entry-chat-only.ts</code>中，做出以下的修改：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TUIChatKit</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../index.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">initChat</span> = (<span class="params">options: Record&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">TARO_ENV</span> === <span class="string">&quot;weapp&quot;</span>) &#123;</span><br><span class="line">    <span class="title class_">TUIChatKit</span>.<span class="title function_">init</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>再搜索<code>#ifndef</code>。</p>
<p><code>server.ts</code>中，将<code>locale</code>相关代码注释掉。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// import TUILocales from &#x27;./locales&#x27;;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// TUITranslateService.provideLanguages(&#123; ...TUILocales &#125;);</span></span><br><span class="line"><span class="comment">// TUITranslateService.useI18n();</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="去除-ts-里对-vue-的引入"><a href="#去除-ts-里对-vue-的引入" class="headerlink" title="去除 ts 里对 vue 的引入"></a>去除 ts 里对 vue 的引入</h3><p>Taro 的 ts 文件里不能直接引入 vue 文件，不然会把编译好的字符串全部直出到页面上。</p>
<p><code>TUIKit/index.ts</code>中：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; genTestUserSig &#125; <span class="keyword">from</span> <span class="string">&quot;./debug&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Server</span> <span class="keyword">from</span> <span class="string">&quot;./server&quot;</span>;</span><br><span class="line"><span class="comment">// import TUIComponents, &#123;</span></span><br><span class="line"><span class="comment">//   TUIChat,</span></span><br><span class="line"><span class="comment">//   TUIConversation,</span></span><br><span class="line"><span class="comment">//   TUIContact,</span></span><br><span class="line"><span class="comment">//   TUISearch,</span></span><br><span class="line"><span class="comment">//   TUIGroup,</span></span><br><span class="line"><span class="comment">// &#125; from &quot;./components&quot;;</span></span><br><span class="line"><span class="comment">// import TUIKit from &quot;./index.vue&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TUIChatKit</span> = <span class="keyword">new</span> <span class="title class_">Server</span>();</span><br><span class="line"><span class="title class_">TUIChatKit</span>.<span class="title function_">init</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="comment">// TUIKit,</span></span><br><span class="line">  <span class="title class_">TUIChatKit</span>,</span><br><span class="line">  <span class="comment">// TUIComponents,</span></span><br><span class="line">  <span class="comment">// TUIChat,</span></span><br><span class="line">  <span class="comment">// TUIConversation,</span></span><br><span class="line">  <span class="comment">// TUIContact,</span></span><br><span class="line">  <span class="comment">// TUISearch,</span></span><br><span class="line">  <span class="comment">// TUIGroup,</span></span><br><span class="line">  genTestUserSig,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="重命名重名组件"><a href="#重命名重名组件" class="headerlink" title="重命名重名组件"></a>重命名重名组件</h3><p><code>TUIKit</code>有一个<code>Icon.vue</code>的组件，很容易跟项目所用的组件库里的组件重名，要给它换个名称。</p>
<p>在所有<code>vue</code>文件中搜索<code>Icon.vue</code>，替换成<code>IconImage.vue</code>，同时将<code>import Icon from</code>替换成<code>import IconImage from</code>，再把<code>&lt;Icon</code>替换成<code>&lt;IconImage</code>，把<code>components/common</code>目录下的<code>Icon.vue</code>重命名为<code>IconImage.vue</code>。</p>
<h3 id="调整样式"><a href="#调整样式" class="headerlink" title="调整样式"></a>调整样式</h3><p>搜索<code>:not(not)</code>相关样式，把它们全部注释掉。</p>
<p>Taro 不支持局部样式，把所有的<code>scoped</code>去除。</p>
<p>在<code>TUIKit/assets/styles/common.scss</code>中，把最顶上的样式重置删除（不是注释，直接删）。</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// body, div, ul, ol, dt, dd, li, dl, h1, h2, h3, h4, p &#123;</span></span><br><span class="line"><span class="comment">//   margin:0;</span></span><br><span class="line"><span class="comment">//   padding:0;</span></span><br><span class="line"><span class="comment">//   font-style:normal;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   /* font:12px/22px&quot;\5B8B\4F53&quot;,Arial,Helvetica,sans-serif; */</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="解决样式覆盖冲突"><a href="#解决样式覆盖冲突" class="headerlink" title="解决样式覆盖冲突"></a>解决样式覆盖冲突</h3><p>上一步把<code>scoped</code>去除后，样式就变成了全局样式，可能会产生样式污染的问题，最常见的是<code>.btn</code>会污染项目里原本就有的<code>.btn</code>。</p>
<p>将<code>.btn</code>改个名吧，统一替换成<code>.tui-btn</code>，注意要只改样式和<code>html</code>，不要影响到其他逻辑里的<code>btn</code>。</p>
<h3 id="替换导航路径"><a href="#替换导航路径" class="headerlink" title="替换导航路径"></a>替换导航路径</h3><p>下面会写到 Taro 的页面跟 uni-app 并不相同，因此导航的路径也会不同。</p>
<p>在所有文件中搜索<code>/TUIKit/components/</code>，按以下规则进行替换：</p>
<ul>
<li><code>/TUIKit/components/TUIChat/video-play</code> —— <code>/TUIKit/pages/TUIChat-video-play/TUIChat-video-play</code></li>
<li><code>/TUIKit/components/TUIChat/index</code> —— <code>/TUIKit/pages/TUIChat/TUIChat</code></li>
<li><code>/TUIKit/components/TUIContact/index</code> —— <code>/TUIKit/pages/TUIContact/TUIContact</code></li>
<li><code>/TUIKit/components/TUIConversation/index</code> —— <code>/TUIKit/pages/TUIConversation/TUIConversation</code></li>
<li><code>/TUIKit/components/TUIGroup/index</code> —— <code>/TUIKit/pages/TUIGroup/TUIGroup</code></li>
<li><code>/TUIKit/components/TUISearch/index</code> —— <code>/TUIKit/pages/TUISearch/TUISearch</code></li>
</ul>
<h3 id="替换变量"><a href="#替换变量" class="headerlink" title="替换变量"></a>替换变量</h3><p>将所有<code>isUniFrameWork</code>替换成<code>isTaroFrameWork</code>。</p>
<p>在<code>TUIKit/utils/env.ts</code>中，做以下的修改：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// declare const uni: any;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isTaroFrameWork = <span class="keyword">typeof</span> <span class="title class_">Taro</span> !== <span class="string">&quot;undefined&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="解决滚动失效问题"><a href="#解决滚动失效问题" class="headerlink" title="解决滚动失效问题"></a>解决滚动失效问题</h3><p>目前 Taro 貌似不支持通过设置<code>scroll-view</code>的<code>scroll-top</code>来滚动页面，在<code>TUIKit/components/TUIChat/message-list/index.vue</code>的末尾加上如下的代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(</span><br><span class="line">  <span class="function">() =&gt;</span> scrollTop.<span class="property">value</span>,</span><br><span class="line">  <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">pageScrollTo</span>(&#123;</span><br><span class="line">      <span class="attr">scrollTop</span>: val,</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="给项目集成库"><a href="#给项目集成库" class="headerlink" title="给项目集成库"></a>给项目集成库</h2><p>主要参考官方文档来一步步做：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/269/64506">https://cloud.tencent.com/document/product/269/64506</a></p>
<p>项目的<code>package.json</code>里添加以下依赖：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/chat-uikit-engine&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/tui-core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/universal-api&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/call-uikit-wechat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/call-uikit-vue2.6&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/call-uikit-vue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@tencentcloud/tui-customer-service-plugin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@vue/composition-api&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.7.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>将<code>TUIKit</code>目录整个复制到项目的<code>src</code>目录下。</p>
<p>将<code>node_modules</code>里的<code>@tencentcloud/tui-customer-service-plugin</code>的<code>tui-customer-service-plugin</code>目录复制到<code>TUIKit</code>目录下。</p>
<p>在<code>tui-customer-service-plugin/componentsmessage-product-card</code>中，做出以下修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang=&quot;ts&quot;&gt;</span><br><span class="line">import Taro from &quot;@tarojs/taro&quot;;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// eslint-disable-next-line</span><br><span class="line">// declare var uni: any;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  ...</span><br><span class="line">  setup(props: Props) &#123;</span><br><span class="line">    const jumpProductCard = () =&gt; &#123;</span><br><span class="line">      if (window) &#123;</span><br><span class="line">        window.open(props.payload.content.url, &quot;_blank&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        Taro.navigateTo(&#123;</span><br><span class="line">          url: `/TUIKit/pages/TUIChat-web-view/TUIChat-web-view?url=$&#123;props.payload.content.url&#125;`,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>app.ts</code>中，进行<code>im</code>的登录操作。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tuiConfig = &#123;</span><br><span class="line">  <span class="title class_">SDKAppID</span>: <span class="number">114514</span>,</span><br><span class="line">  <span class="attr">userID</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">  <span class="attr">userSig</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">App</span> = <span class="title function_">createApp</span>(&#123;</span><br><span class="line">  <span class="title function_">onShow</span>(<span class="params">options</span>) &#123;&#125;,</span><br><span class="line">  <span class="comment">// 入口组件不需要实现 render 方法，即使实现了也会被 taro 所覆盖</span></span><br><span class="line">  <span class="title function_">onLaunch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">TUILogin</span>.<span class="title function_">login</span>(&#123;</span><br><span class="line">      ...tuiConfig,</span><br><span class="line">      <span class="attr">useUploadPlugin</span>: <span class="literal">true</span>, <span class="comment">// If you need to send rich media messages, please set to true.</span></span><br><span class="line">      <span class="attr">framework</span>: <span class="string">`vue3`</span>, <span class="comment">// framework used vue2 / vue3</span></span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于 Taro 的单个页面下只支持一个<code>vue</code>文件，我们不能直接用<code>TUIKit/components</code>里的组件作为页面。</p>
<p>新建一个<code>TUIKit/pages</code>目录，再将所有组件对应的目录、以及它下面的<code>vue</code>文件和<code>ts</code>配置也创建下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUIChat</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUIContact</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUIConversation</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUIGroup</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUISearch</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUIChat-video-play</span><br><span class="line"><span class="built_in">mkdir</span> src/TUIKit/pages/TUIChat-web-view</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIChat/TUIChat.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIChat/TUIChat.config.ts</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIContact/TUIContact.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIContact/TUIContact.config.ts</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIConversation/TUIConversation.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIConversation/TUIConversation.config.ts</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIGroup/TUIGroup.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIGroup/TUIGroup.config.ts</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUISearch/TUISearch.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUISearch/TUISearch.config.ts</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIChat-video-play/TUIChat-video-play.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIChat-video-play/TUIChat-video-play.config.ts</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIChat-web-view/TUIChat-web-view.vue</span><br><span class="line"><span class="built_in">touch</span> src/TUIKit/pages/TUIChat-web-view/TUIChat-web-view.config.ts</span><br></pre></td></tr></table></figure>

<p>所有的<code>config.ts</code>文件里添加统一的配置。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">definePageConfig</span>(&#123;</span><br><span class="line">  <span class="attr">navigationBarTitleText</span>: <span class="string">&quot;消息&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>每个<code>vue</code>文件里引入<code>components</code>目录下对应的组件（以 TUIChat.vue 为例）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang=&quot;ts&quot; setup&gt;</span><br><span class="line">import TUIChat from &quot;@/TUIKit/components/TUIChat/index.vue&quot;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;TUIChat&gt;&lt;/TUIChat&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>最后在<code>app.config.ts</code>里添加对应的分包（要看项目，不一定加所有的页面）。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineAppConfig</span>(&#123;</span><br><span class="line">  <span class="attr">subPackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&quot;TUIKit&quot;</span>,</span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&quot;pages/TUIConversation/TUIConversation&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pages/TUIChat/TUIChat&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pages/TUIChat-video-play/TUIChat-video-play&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pages/TUIChat-web-view/TUIChat-web-view&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pages/TUIContact/TUIContact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pages/TUIGroup/TUIGroup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pages/TUISearch/TUISearch&quot;</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">preloadRule</span>: &#123;</span><br><span class="line">    <span class="string">&quot;pages/index/index&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">network</span>: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&quot;TUIKit&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="优化主包体积过大问题"><a href="#优化主包体积过大问题" class="headerlink" title="优化主包体积过大问题"></a>优化主包体积过大问题</h2><p>可以用<code>webpack-bundle-analyzer</code>插件来直观地查看依赖大小，以进一步地优化体积。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i webpack-bundle-analyzer -D</span><br></pre></td></tr></table></figure>

<p><code>config/prod.ts</code>中这么配置：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">mini</span>: &#123;</span><br><span class="line">    <span class="title function_">webpackChain</span>(<span class="params">chain, webpack</span>) &#123;</span><br><span class="line">      chain</span><br><span class="line">        .<span class="title function_">plugin</span>(<span class="string">&quot;analyzer&quot;</span>)</span><br><span class="line">        .<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&quot;webpack-bundle-analyzer&quot;</span>).<span class="property">BundleAnalyzerPlugin</span>, []);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样就能很直观地看到<code>TUIKit</code>相关的依赖足足占了 1 个多<code>M</code>，WTF！</p>
<p>如果你小程序主包的页面很多且体积很大，就把除了<code>tab</code>页以外的页面全放到分包里吧。</p>
<p>项目里有<code>echarts</code>这个大头的话，把它也放到分包里吧。</p>
<h2 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h2><p>可以根据项目需求来进一步地改进和优化<code>TUIKit/components</code>里的组件。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>费了一番功夫，总算迁移完成。</p>
<p>只能说 TX 你做得好啊，你做的好。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">alphardex</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://alphardex.github.io/mygo/posts/36637/">https://alphardex.github.io/mygo/posts/36637/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/mygo/posts/59816/"><i class="fa fa-chevron-left">  </i><span>我的 MyGO!!!!!上海演唱会抢票历程</span></a></div><div class="next-post pull-right"><a href="/mygo/posts/63891/"><span>从零开始的 cosplay 之旅</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'MUKqiaU6CnxOn2VeT4cUBLdG-gzGzoHsz',
  appKey:'nxePlNHUgdOaABmHUoWz4TpR',
  placeholder:'何が言いたいことがある？',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2024/05/21/HtNjkzv1FEdAVby.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2024 By alphardex</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/mygo/js/utils.js?version=1.9.1"></script><script src="/mygo/js/fancybox.js?version=1.9.1"></script><script src="/mygo/js/sidebar.js?version=1.9.1"></script><script src="/mygo/js/copy.js?version=1.9.1"></script><script src="/mygo/js/fireworks.js?version=1.9.1"></script><script src="/mygo/js/transition.js?version=1.9.1"></script><script src="/mygo/js/scroll.js?version=1.9.1"></script><script src="/mygo/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>