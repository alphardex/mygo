<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="用 three.js 渲染真实的下雨效果"><meta name="keywords" content=""><meta name="author" content="alphardex"><meta name="copyright" content="alphardex"><title>用 three.js 渲染真实的下雨效果 | 名無声</title><link rel="shortcut icon" href="/mygo/img/favicon.ico"><link rel="stylesheet" href="/mygo/css/index.css?version=1.9.1"><link rel="stylesheet" href="/mygo/css/mygo.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/mygo/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '7.2.0'
} </script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/mygo/atom.xml" title="名無声" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E6%A8%A1"><span class="toc-number">1.</span> <span class="toc-text">建模</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%AF%E6%B0%B4%E5%9C%B0%E9%9D%A2"><span class="toc-number">2.</span> <span class="toc-text">积水地面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%9F%E6%BC%AA%E6%95%88%E6%9E%9C"><span class="toc-number">2.1.</span> <span class="toc-text">涟漪效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8E%E5%9C%B0%E9%9D%A2%E7%BB%93%E5%90%88"><span class="toc-number">2.2.</span> <span class="toc-text">与地面结合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E9%9B%A8%E5%8A%A8%E7%94%BB"><span class="toc-number">3.</span> <span class="toc-text">下雨动画</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%9B%A8%E6%BB%B4"><span class="toc-number">3.1.</span> <span class="toc-text">生成雨滴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%90%BD%E5%8A%A8%E7%94%BB"><span class="toc-number">3.2.</span> <span class="toc-text">下落动画</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E6%95%88%E6%9E%9C"><span class="toc-number">3.3.</span> <span class="toc-text">反射效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%81%AF%E5%85%89%E9%97%AA%E7%83%81"><span class="toc-number">4.</span> <span class="toc-text">灯光闪烁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E6%9C%9F%E5%A4%84%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">后期处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%85%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">待优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">7.</span> <span class="toc-text">最后</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s2.loli.net/2024/05/21/NhyV4THWaAgOwED.jpg"></div><div class="author-info__name text-center">alphardex</div><div class="author-info__description text-center">&quot;普通&quot;とか&quot;あたりまえ&quot;ってなんだろう</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/mygo/archives"><span class="pull-left">Articles</span><span class="pull-right">44</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.loli.net/2024/05/21/HtNjkzv1FEdAVby.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/mygo/">名無声</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/mygo/">Home</a><a class="site-page" href="/mygo/archives">Archives</a><a class="site-page" href="/mygo/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">用 three.js 渲染真实的下雨效果</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-02-15</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>呀哈喽！这里是 alphardex。</p>
<p>最近我用 three.js 模拟了一下现实中的下雨效果，让我们一起来看看它是怎么实现的吧。</p>
<p><a target="_blank" rel="noopener" href="https://code.juejin.cn/pen/7200287096689393720">https://code.juejin.cn/pen/7200287096689393720</a></p>
<span id="more"></span>

<h2 id="建模"><a href="#建模" class="headerlink" title="建模"></a>建模</h2><p>首先我们需要一些贴图素材</p>
<p>贴图素材一般可以在<a target="_blank" rel="noopener" href="https://3dtextures.me/">3dtextures</a>网站上找到，这里我找了 2 份，包含了墙的法线贴图和潮湿地面的法线、透明度、粗糙度贴图</p>
<p>通过<a target="_blank" rel="noopener" href="https://github.com/alphardex/kokomi.js/blob/main/src/components/assetManager.ts">kokomi.AssetManager</a>将贴图素材一次性全部加载出来，将它们应用到<code>Mesh</code>上，加上基本的环境光照，即可完成最基本的建模</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 光照</span></span><br><span class="line"><span class="keyword">const</span> pointLight1 = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">PointLight</span>(config.<span class="property">color</span>, <span class="number">0.5</span>, <span class="number">17</span>, <span class="number">0.8</span>);</span><br><span class="line">pointLight1.<span class="property">position</span>.<span class="title function_">set</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">add</span>(pointLight1);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网格</span></span><br><span class="line"><span class="keyword">const</span> aspTex = am.<span class="property">items</span>[<span class="string">&quot;asphalt-normal&quot;</span>];</span><br><span class="line">aspTex.<span class="property">rotation</span> = <span class="variable constant_">THREE</span>.<span class="property">MathUtils</span>.<span class="title function_">degToRad</span>(<span class="number">90</span>);</span><br><span class="line">aspTex.<span class="property">wrapS</span> = aspTex.<span class="property">wrapT</span> = <span class="variable constant_">THREE</span>.<span class="property">RepeatWrapping</span>;</span><br><span class="line">aspTex.<span class="property">repeat</span>.<span class="title function_">set</span>(<span class="number">5</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wallMat = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">MeshPhongMaterial</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Color</span>(<span class="string">&quot;#111111&quot;</span>),</span><br><span class="line">  <span class="attr">normalMap</span>: aspTex,</span><br><span class="line">  <span class="attr">normalScale</span>: <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Vector2</span>(<span class="number">0.5</span>, <span class="number">0.5</span>),</span><br><span class="line">  <span class="attr">shininess</span>: <span class="number">200</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wall = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Mesh</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">BoxGeometry</span>(<span class="number">25</span>, <span class="number">20</span>, <span class="number">0.5</span>), wallMat);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">add</span>(wall);</span><br><span class="line">wall.<span class="property">position</span>.<span class="property">y</span> = <span class="number">10</span>;</span><br><span class="line">wall.<span class="property">position</span>.<span class="property">z</span> = -<span class="number">10.3</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文字</span></span><br><span class="line"><span class="keyword">const</span> t3d = <span class="keyword">new</span> kokomi.<span class="title class_">Text3D</span>(<span class="variable language_">this</span>, config.<span class="property">text</span>, font, &#123;</span><br><span class="line">  <span class="attr">size</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">height</span>: <span class="number">0.2</span>,</span><br><span class="line">  <span class="attr">curveSegments</span>: <span class="number">120</span>,</span><br><span class="line">  <span class="attr">bevelEnabled</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line">t3d.<span class="property">mesh</span>.<span class="property">geometry</span>.<span class="title function_">center</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tm = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Mesh</span>(</span><br><span class="line">  t3d.<span class="property">mesh</span>.<span class="property">geometry</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">MeshBasicMaterial</span>(&#123;</span><br><span class="line">    <span class="attr">color</span>: config.<span class="property">color</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">add</span>(tm);</span><br><span class="line">tm.<span class="property">position</span>.<span class="property">y</span> = <span class="number">1.54</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/15/wMHvm2rUXRojbg8.jpg" alt="1.jpg"></p>
<h2 id="积水地面"><a href="#积水地面" class="headerlink" title="积水地面"></a>积水地面</h2><p>地面上的积水能反射出周围的景色，因此我们将选用<a target="_blank" rel="noopener" href="https://github.com/alphardex/kokomi.js/blob/main/src/lib/three-stdlib/reflector.ts">kokomi.Reflector</a>来实现反射效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mirror = <span class="keyword">new</span> kokomi.<span class="title class_">Reflector</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">PlaneGeometry</span>(<span class="number">25</span>, <span class="number">100</span>));</span><br><span class="line">mirror.<span class="property">position</span>.<span class="property">z</span> = -<span class="number">25</span>;</span><br><span class="line">mirror.<span class="property">rotation</span>.<span class="property">x</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/16/q9JiwlFgvrAXN4W.jpg" alt="reflector.jpg"></p>
<p>普通的反射器仅仅是一面镜子，因此我们要自定义反射器的 Shader</p>
<h3 id="涟漪效果"><a href="#涟漪效果" class="headerlink" title="涟漪效果"></a>涟漪效果</h3><p>之前逛 shadertoy 时看到了一个很棒的<a target="_blank" rel="noopener" href="https://www.shadertoy.com/view/ldfyzl">涟漪特效</a>，就直接拿来用了</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://www.shadertoy.com/view/4djSRW</span></span><br><span class="line"><span class="type">float</span> hash12(<span class="type">vec2</span> p)&#123;</span><br><span class="line">    <span class="type">vec3</span> p3=<span class="built_in">fract</span>(<span class="type">vec3</span>(p.xyx)*<span class="number">.1031</span>);</span><br><span class="line">    p3+=<span class="built_in">dot</span>(p3,p3.yzx+<span class="number">19.19</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>((p3.x+p3.y)*p3.z);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> hash22(<span class="type">vec2</span> p)&#123;</span><br><span class="line">    <span class="type">vec3</span> p3=<span class="built_in">fract</span>(<span class="type">vec3</span>(p.xyx)*<span class="type">vec3</span>(<span class="number">.1031</span>,<span class="number">.1030</span>,<span class="number">.0973</span>));</span><br><span class="line">    p3+=<span class="built_in">dot</span>(p3,p3.yzx+<span class="number">19.19</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>((p3.xx+p3.yz)*p3.zy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://gist.github.com/companje/29408948f1e8be54dd5733a74ca49bb9</span></span><br><span class="line"><span class="type">float</span> map(<span class="type">float</span> value,<span class="type">float</span> min1,<span class="type">float</span> max1,<span class="type">float</span> min2,<span class="type">float</span> max2)&#123;</span><br><span class="line">    <span class="keyword">return</span> min2+(value-min1)*(max2-min2)/(max1-min1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> rippleUv=<span class="number">75.</span>*p*uTexScale;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> p0=<span class="built_in">floor</span>(rippleUv);</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> rainStrength=map(uRainCount,<span class="number">0.</span>,<span class="number">10000.</span>,<span class="number">3.</span>,<span class="number">.5</span>);</span><br><span class="line"><span class="keyword">if</span>(rainStrength==<span class="number">3.</span>)&#123;</span><br><span class="line">    rainStrength=<span class="number">50.</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> circles=<span class="type">vec2</span>(<span class="number">0.</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=-MAX_RADIUS;j&lt;=MAX_RADIUS;++j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=-MAX_RADIUS;i&lt;=MAX_RADIUS;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">vec2</span> pi=p0+<span class="type">vec2</span>(i,j);</span><br><span class="line">        <span class="meta">#if DOUBLE_HASH</span></span><br><span class="line">        <span class="type">vec2</span> hsh=hash22(pi);</span><br><span class="line">        <span class="meta">#else</span></span><br><span class="line">        <span class="type">vec2</span> hsh=pi;</span><br><span class="line">        <span class="meta">#endif</span></span><br><span class="line">        <span class="type">vec2</span> p=pi+hash22(hsh);</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> t=<span class="built_in">fract</span>(<span class="number">.8</span>*iTime+hash12(hsh));</span><br><span class="line">        <span class="type">vec2</span> v=p-rippleUv;</span><br><span class="line">        <span class="type">float</span> d=<span class="built_in">length</span>(v)-(<span class="type">float</span>(MAX_RADIUS)+<span class="number">1.</span>)*t+(rainStrength*<span class="number">.1</span>*t);</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> h=<span class="number">1e-3</span>;</span><br><span class="line">        <span class="type">float</span> d1=d-h;</span><br><span class="line">        <span class="type">float</span> d2=d+h;</span><br><span class="line">        <span class="type">float</span> p1=<span class="built_in">sin</span>(<span class="number">31.</span>*d1)*<span class="built_in">smoothstep</span>(<span class="number">-.6</span>,<span class="number">-.3</span>,d1)*<span class="built_in">smoothstep</span>(<span class="number">0.</span>,<span class="number">-.3</span>,d1);</span><br><span class="line">        <span class="type">float</span> p2=<span class="built_in">sin</span>(<span class="number">31.</span>*d2)*<span class="built_in">smoothstep</span>(<span class="number">-.6</span>,<span class="number">-.3</span>,d2)*<span class="built_in">smoothstep</span>(<span class="number">0.</span>,<span class="number">-.3</span>,d2);</span><br><span class="line">        circles+=<span class="number">.5</span>*<span class="built_in">normalize</span>(v)*((p2-p1)/(<span class="number">2.</span>*h)*(<span class="number">1.</span>-t)*(<span class="number">1.</span>-t));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">circles/=<span class="type">float</span>((MAX_RADIUS*<span class="number">2</span>+<span class="number">1</span>)*(MAX_RADIUS*<span class="number">2</span>+<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> intensity=<span class="number">.05</span>*floorOpacity;</span><br><span class="line"><span class="type">vec3</span> n=<span class="type">vec3</span>(circles,<span class="built_in">sqrt</span>(<span class="number">1.</span>-<span class="built_in">dot</span>(circles,circles)));</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> rainUv=intensity*n.xy;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/16/ekqoi6MLm7IcQl1.jpg" alt="ripple.jpg"></p>
<h3 id="与地面结合"><a href="#与地面结合" class="headerlink" title="与地面结合"></a>与地面结合</h3><p>光有涟漪效果也不够，要将它与地面的贴图相结合起来</p>
<p>这里采用了<code>自定义mipmap</code>技术，利用<a target="_blank" rel="noopener" href="https://github.com/alphardex/kokomi.js/blob/main/src/lib/custom-mipmap-generation/PackedMipMapGenerator.ts">kokomi.PackedMipMapGenerator</a>生成了多个贴图的 mipmap</p>
<p>自定义 mipmap 除了能捆绑贴图外，还有个好处就是可以动态控制贴图的模糊程度</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mipmapper = <span class="keyword">new</span> kokomi.<span class="title class_">PackedMipMapGenerator</span>();</span><br><span class="line"><span class="keyword">const</span> mirrorFBO = mirror.<span class="title function_">getRenderTarget</span>();</span><br><span class="line"><span class="keyword">const</span> mipmapFBO = <span class="keyword">new</span> kokomi.<span class="title function_">FBO</span>(<span class="variable language_">this</span>);</span><br><span class="line">mirror.<span class="property">material</span>.<span class="property">uniforms</span>.<span class="property">tDiffuse</span>.<span class="property">value</span> = mipmapFBO.<span class="property">rt</span>.<span class="property">texture</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">update</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  mipmapper.<span class="title function_">update</span>(mirrorFBO.<span class="property">texture</span>, mipmapFBO.<span class="property">rt</span>, <span class="variable language_">this</span>.<span class="property">renderer</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec2</span> p=vUv;</span><br><span class="line"><span class="type">vec2</span> texUv=p*uTexScale;</span><br><span class="line">texUv+=uTexOffset;</span><br><span class="line"><span class="type">float</span> floorOpacity=<span class="built_in">texture</span>(uOpacityTexture,texUv).r;</span><br><span class="line"><span class="type">vec3</span> floorNormal=<span class="built_in">texture</span>(uNormalTexture,texUv).rgb*<span class="number">2.</span><span class="number">-1.</span>;</span><br><span class="line">floorNormal=<span class="built_in">normalize</span>(floorNormal);</span><br><span class="line"><span class="type">float</span> roughness=<span class="built_in">texture</span>(uRoughnessTexture,texUv).r;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> finalUv=reflectionUv+floorNormal.xy*uDistortionAmount-rainUv;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> level=roughness*uBlurStrength;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> col=packedTexture2DLOD(tDiffuse,finalUv,level,uMipmapTextureSize).rgb;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/15/PRxHYhcEk7ydgCJ.gif" alt="2.gif"></p>
<h2 id="下雨动画"><a href="#下雨动画" class="headerlink" title="下雨动画"></a>下雨动画</h2><h3 id="生成雨滴"><a href="#生成雨滴" class="headerlink" title="生成雨滴"></a>生成雨滴</h3><p>雨滴数量会很多，因此要用到<a target="_blank" rel="noopener" href="https://threejs.org/docs/index.html#api/en/objects/InstancedMesh">THREE.InstancedMesh</a>来生成实例化网格对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rain = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">InstancedMesh</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">PlaneGeometry</span>(), rainMat, count);</span><br><span class="line">rain.<span class="property">instanceMatrix</span>.<span class="property">needsUpdate</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dummy = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Object3D</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rain.<span class="property">count</span>; i++) &#123;</span><br><span class="line">  dummy.<span class="property">position</span>.<span class="title function_">set</span>(</span><br><span class="line">    <span class="variable constant_">THREE</span>.<span class="property">MathUtils</span>.<span class="title function_">randFloat</span>(-<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="variable constant_">THREE</span>.<span class="property">MathUtils</span>.<span class="title function_">randFloat</span>(-<span class="number">20</span>, <span class="number">10</span>)</span><br><span class="line">  );</span><br><span class="line">  dummy.<span class="property">scale</span>.<span class="title function_">set</span>(<span class="number">0.03</span>, <span class="variable constant_">THREE</span>.<span class="property">MathUtils</span>.<span class="title function_">randFloat</span>(<span class="number">0.3</span>, <span class="number">0.5</span>), <span class="number">0.03</span>);</span><br><span class="line">  dummy.<span class="title function_">updateMatrix</span>();</span><br><span class="line">  rain.<span class="title function_">setMatrixAt</span>(i, dummy.<span class="property">matrix</span>);</span><br><span class="line">&#125;</span><br><span class="line">rain.<span class="property">rotation</span>.<span class="title function_">set</span>(-<span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0.1</span>);</span><br><span class="line">rain.<span class="property">position</span>.<span class="title function_">set</span>(<span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>这里要注意一点：雨滴的方向是始终朝向用户的，为了达成这点就要用<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55582846/how-do-i-implement-an-instanced-billboard-in-three-js">billboard</a>方案来实现</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec3</span> billboard(<span class="type">vec3</span> v,<span class="type">mat4</span> view)&#123;</span><br><span class="line">    <span class="type">vec3</span> up=<span class="type">vec3</span>(view[<span class="number">0</span>][<span class="number">1</span>],view[<span class="number">1</span>][<span class="number">1</span>],view[<span class="number">2</span>][<span class="number">1</span>]);</span><br><span class="line">    <span class="type">vec3</span> right=<span class="type">vec3</span>(view[<span class="number">0</span>][<span class="number">0</span>],view[<span class="number">1</span>][<span class="number">0</span>],view[<span class="number">2</span>][<span class="number">0</span>]);</span><br><span class="line">    <span class="type">vec3</span> pos=right*v.x+up*v.y;</span><br><span class="line">    <span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> billboardPos=billboard(transformed,modelViewMatrix);</span><br><span class="line">transformed=billboardPos;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/16/lBsYRUgcy9fj2mW.jpg" alt="rain-1.jpg"></p>
<h3 id="下落动画"><a href="#下落动画" class="headerlink" title="下落动画"></a>下落动画</h3><p>我们可以给雨滴赋予随机的高度和速度 attribute，并在顶点着色器中让它动起来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> progressArr = [];</span><br><span class="line"><span class="keyword">const</span> speedArr = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rain.<span class="property">count</span>; i++) &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  progressArr.<span class="title function_">push</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">  speedArr.<span class="title function_">push</span>(dummy.<span class="property">scale</span>.<span class="property">y</span> * <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rain.<span class="property">geometry</span>.<span class="title function_">setAttribute</span>(</span><br><span class="line">  <span class="string">&quot;aProgress&quot;</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">InstancedBufferAttribute</span>(<span class="keyword">new</span> <span class="title class_">Float32Array</span>(progressArr), <span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line">rain.<span class="property">geometry</span>.<span class="title function_">setAttribute</span>(</span><br><span class="line">  <span class="string">&quot;aSpeed&quot;</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">InstancedBufferAttribute</span>(<span class="keyword">new</span> <span class="title class_">Float32Array</span>(speedArr), <span class="number">1</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">float</span> aProgress;</span><br><span class="line"><span class="keyword">attribute</span> <span class="type">float</span> aSpeed;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> uSpeed;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> uHeightRange;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> distort(<span class="type">vec3</span> p)&#123;</span><br><span class="line">    <span class="type">float</span> y=<span class="built_in">mod</span>(aProgress-iTime*aSpeed*<span class="number">.25</span>*uSpeed,<span class="number">1.</span>)*uHeightRange-(uHeightRange*<span class="number">.5</span>);</span><br><span class="line">    p.y+=y;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">transformed=distort(transformed);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/16/C2U6lPb81NSOLch.gif" alt="rain-2.gif"></p>
<h3 id="反射效果"><a href="#反射效果" class="headerlink" title="反射效果"></a>反射效果</h3><p>创建背景的离屏渲染 FBO，将其作为反射的主要材质</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bgFBO = <span class="keyword">new</span> kokomi.<span class="title function_">FBO</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">  <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">innerWidth</span> * <span class="number">0.1</span>,</span><br><span class="line">  <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">innerHeight</span> * <span class="number">0.1</span>,</span><br><span class="line">&#125;);</span><br><span class="line">rainMat.<span class="property">uniforms</span>.<span class="property">uBgRt</span>.<span class="property">value</span> = bgFBO.<span class="property">rt</span>.<span class="property">texture</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fboCamera = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">clone</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">update</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  rain.<span class="property">visible</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">renderer</span>.<span class="title function_">setRenderTarget</span>(bgFBO.<span class="property">rt</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">renderer</span>.<span class="title function_">render</span>(<span class="variable language_">this</span>.<span class="property">scene</span>, fboCamera);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">renderer</span>.<span class="title function_">setRenderTarget</span>(<span class="literal">null</span>);</span><br><span class="line">  rain.<span class="property">visible</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在顶点着色器中获取屏幕空间<code>vScreenspace</code></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Samsy/glsl-screenspace</span></span><br><span class="line"><span class="type">vec2</span> screenspace(<span class="type">mat4</span> projectionmatrix,<span class="type">mat4</span> modelviewmatrix,<span class="type">vec3</span> position)&#123;</span><br><span class="line">    <span class="type">vec4</span> temp=projectionmatrix*modelviewmatrix*<span class="type">vec4</span>(position,<span class="number">1.</span>);</span><br><span class="line">    temp.xyz/=temp.w;</span><br><span class="line">    temp.xy=(<span class="number">.5</span>)+(temp.xy)*<span class="number">.5</span>;</span><br><span class="line">    <span class="keyword">return</span> temp.xy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vScreenspace=screenspace(projectionMatrix,modelViewMatrix,transformed);</span><br></pre></td></tr></table></figure>

<p>在片元着色器中采样反射材质</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> uNormalTexture;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> uBgRt;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> uRefraction;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> uBaseBrightness;</span><br><span class="line"></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> vScreenspace;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()&#123;</span><br><span class="line">    <span class="type">vec2</span> p=vUv;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec4</span> normalColor=<span class="built_in">texture</span>(uNormalTexture,p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(normalColor.a&lt;<span class="number">.5</span>)&#123;</span><br><span class="line">        <span class="keyword">discard</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> normal=<span class="built_in">normalize</span>(normalColor.rgb);</span><br><span class="line"></span><br><span class="line">    <span class="type">vec2</span> bgUv=vScreenspace+normal.xy*uRefraction;</span><br><span class="line">    <span class="type">vec4</span> bgColor=<span class="built_in">texture</span>(uBgRt,bgUv);</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> brightness=uBaseBrightness*<span class="built_in">pow</span>(normal.b,<span class="number">10.</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> col=bgColor.rgb+<span class="type">vec3</span>(brightness);</span><br><span class="line"></span><br><span class="line">    col=<span class="type">vec3</span>(p,<span class="number">0.</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gl_FragColor</span>=<span class="type">vec4</span>(col,<span class="number">1.</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有一点要注意：积水地面中要把雨滴的反射去掉，不然会看着很乱</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rainFloor.<span class="property">mirror</span>.<span class="property">ignoreObjects</span>.<span class="title function_">push</span>(rain);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/15/oH2gnGqXftYeBFJ.gif" alt="3.gif"></p>
<h2 id="灯光闪烁"><a href="#灯光闪烁" class="headerlink" title="灯光闪烁"></a>灯光闪烁</h2><p>用<code>setInterval</code>来间歇地设置文字和灯光材质的颜色即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flicker</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">turnOffLight</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  tm.<span class="property">material</span>.<span class="property">color</span>.<span class="title function_">copy</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Color</span>(<span class="string">&quot;black&quot;</span>));</span><br><span class="line">  pointLight1.<span class="property">color</span>.<span class="title function_">copy</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Color</span>(<span class="string">&quot;black&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">turnOnLight</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  tm.<span class="property">material</span>.<span class="property">color</span>.<span class="title function_">copy</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Color</span>(config.<span class="property">color</span>));</span><br><span class="line">  pointLight1.<span class="property">color</span>.<span class="title function_">copy</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Color</span>(config.<span class="property">color</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flickerTimer = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">flicker</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  flickerTimer = <span class="built_in">setInterval</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> rate = <span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">    <span class="keyword">if</span> (rate &lt; <span class="number">0.5</span>) &#123;</span><br><span class="line">      <span class="title function_">turnOffLight</span>();</span><br><span class="line">      <span class="keyword">await</span> kokomi.<span class="title function_">sleep</span>(<span class="number">200</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">      <span class="title function_">turnOnLight</span>();</span><br><span class="line">      <span class="keyword">await</span> kokomi.<span class="title function_">sleep</span>(<span class="number">200</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">      <span class="title function_">turnOffLight</span>();</span><br><span class="line">      <span class="keyword">await</span> kokomi.<span class="title function_">sleep</span>(<span class="number">200</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">      <span class="title function_">turnOnLight</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">flicker</span>();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/15/zm8vM9TA5eCS1b6.gif" alt="4.gif"></p>
<h2 id="后期处理"><a href="#后期处理" class="headerlink" title="后期处理"></a>后期处理</h2><p>为了让文字灯光看上去更加明亮，可以用<code>Bloom</code>滤镜来照亮文字</p>
<p>由于后期处理中原先 renderer 的抗锯齿会失效，故用<code>SMAA</code>滤镜来实现抗锯齿</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// postprocessing</span></span><br><span class="line"><span class="keyword">const</span> composer = <span class="keyword">new</span> <span class="variable constant_">POSTPROCESSING</span>.<span class="title class_">EffectComposer</span>(<span class="variable language_">this</span>.<span class="property">renderer</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">composer</span> = composer;</span><br><span class="line"></span><br><span class="line">composer.<span class="title function_">addPass</span>(<span class="keyword">new</span> <span class="variable constant_">POSTPROCESSING</span>.<span class="title class_">RenderPass</span>(<span class="variable language_">this</span>.<span class="property">scene</span>, <span class="variable language_">this</span>.<span class="property">camera</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// bloom</span></span><br><span class="line"><span class="keyword">const</span> bloom = <span class="keyword">new</span> <span class="variable constant_">POSTPROCESSING</span>.<span class="title class_">BloomEffect</span>(&#123;</span><br><span class="line">  <span class="attr">luminanceThreshold</span>: <span class="number">0.4</span>,</span><br><span class="line">  <span class="attr">luminanceSmoothing</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">mipmapBlur</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">intensity</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">radius</span>: <span class="number">0.4</span>,</span><br><span class="line">&#125;);</span><br><span class="line">composer.<span class="title function_">addPass</span>(<span class="keyword">new</span> <span class="variable constant_">POSTPROCESSING</span>.<span class="title class_">EffectPass</span>(<span class="variable language_">this</span>.<span class="property">camera</span>, bloom));</span><br><span class="line"></span><br><span class="line"><span class="comment">// antialiasing</span></span><br><span class="line"><span class="keyword">const</span> smaa = <span class="keyword">new</span> <span class="variable constant_">POSTPROCESSING</span>.<span class="title class_">SMAAEffect</span>();</span><br><span class="line">composer.<span class="title function_">addPass</span>(<span class="keyword">new</span> <span class="variable constant_">POSTPROCESSING</span>.<span class="title class_">EffectPass</span>(<span class="variable language_">this</span>.<span class="property">camera</span>, smaa));</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/15/ObcQdI1wANFyk9J.gif" alt="5.gif"></p>
<h2 id="待优化"><a href="#待优化" class="headerlink" title="待优化"></a>待优化</h2><p>效果算是基本实现了，但也有很多待优化的点</p>
<ol>
<li>添加现实中的雨声</li>
<li>实现更棒的相机交互</li>
<li>添加更多的物体</li>
</ol>
<p>……</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>希望本文能给你创作新特效的灵感，keep creating~</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">alphardex</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://alphardex.github.io/mygo/posts/5999/">https://alphardex.github.io/mygo/posts/5999/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/mygo/posts/44091/"><i class="fa fa-chevron-left">  </i><span>如何美化一个 three.js 的场景渲染</span></a></div><div class="next-post pull-right"><a href="/mygo/posts/2989/"><span>中二魔法使的 2022 年终总结</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'MUKqiaU6CnxOn2VeT4cUBLdG-gzGzoHsz',
  appKey:'nxePlNHUgdOaABmHUoWz4TpR',
  placeholder:'何が言いたいことがある？',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2024/05/21/HtNjkzv1FEdAVby.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2024 By alphardex</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/mygo/js/utils.js?version=1.9.1"></script><script src="/mygo/js/fancybox.js?version=1.9.1"></script><script src="/mygo/js/sidebar.js?version=1.9.1"></script><script src="/mygo/js/copy.js?version=1.9.1"></script><script src="/mygo/js/fireworks.js?version=1.9.1"></script><script src="/mygo/js/transition.js?version=1.9.1"></script><script src="/mygo/js/scroll.js?version=1.9.1"></script><script src="/mygo/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>